# マルチテナントシステムガイド

## 概要

このプロジェクトはマルチテナント対応になりました。各テナント（店舗）は独立したデータとユーザーを持ち、スーパー管理者は全テナントにアクセスできます。

## セットアップ

### 1. 既存システムのマルチテナント移行

```bash
# データベースのバックアップを取ることを推奨
npm run migrate:multitenant
```

このコマンドは以下を実行します：
- デフォルトテナント「木村屋本店」を作成
- 既存ユーザーをデフォルトテナントに割り当て
- 最初のユーザーをスーパー管理者に設定

### 2. 新しいテナントの追加

#### 対話形式で追加
```bash
npm run add:tenant
```

質問に答えながらテナントを設定します：
- 店舗名
- スラッグ（URL用の識別子）
- プリセット（レストラン/カフェ/支店/カスタム）
- 連絡先情報
- 管理者ユーザーの作成

#### 設定ファイルから追加
```bash
npm run add:tenant -- --config=tenants/shinjuku.json
```

設定ファイルの例は `tenants/example-tenant.json` を参照してください。

### 3. テナント一覧の確認

```bash
npm run list:tenants
```

登録されているすべてのテナントを表示します。

## ユーザー権限

### スーパー管理者
- すべてのテナントにアクセス可能
- テナントの作成・編集・削除が可能
- システム全体の設定を管理

### テナント管理者
- 割り当てられたテナントのみアクセス可能
- テナント内のコンテンツとユーザーを管理
- 他のテナントのデータは閲覧不可

### 一般ユーザー
- 割り当てられたテナントのコンテンツを閲覧・編集
- 管理機能へのアクセスは制限

## テナント設定

各テナントは以下の設定を持ちます：

### 基本情報
- **名前**: 店舗の表示名
- **スラッグ**: URL等で使用される識別子
- **ステータス**: active/inactive/maintenance

### カスタマイズ
- **ドメイン**: カスタムドメイン（例: shinjuku.kimuraya.com）
- **テーマ**: プライマリカラー、ロゴ
- **機能**: 有効/無効にする機能の選択

### 制限
- **最大ユーザー数**: テナントに所属できるユーザー数の上限
- **最大記事数**: 作成できる記事数の上限

## 開発者向け情報

### アクセス制御

```typescript
// テナントベースのアクセス制御
import { tenantAccess } from '@/access/tenantAccess'

export const Articles: CollectionConfig = {
  access: {
    read: tenantAccess,
    create: tenantAccess,
    update: tenantAccess,
    delete: tenantAccess,
  },
  // ...
}
```

### テナントフィールドの自動設定

```typescript
// beforeChangeフックでテナントを自動設定
hooks: {
  beforeChange: [
    async ({ data, req }) => {
      if (!data.tenant && req.user?.currentTenant) {
        data.tenant = req.user.currentTenant
      }
      return data
    },
  ],
}
```

### テナント切り替え（今後実装予定）

管理画面のヘッダーにテナント切り替えドロップダウンを追加予定です。

## トラブルシューティング

### テナントが作成できない
- PostgreSQLが起動していることを確認
- DATABASE_URIが正しく設定されていることを確認
- スーパー管理者権限でログインしていることを確認

### ユーザーがテナントにアクセスできない
- ユーザーのtenants配列に対象テナントが含まれているか確認
- currentTenantが正しく設定されているか確認

### データが表示されない
- データにtenantフィールドが設定されているか確認
- アクセス制御が正しく実装されているか確認

## 今後の実装予定

1. **テナント切り替えUI**: 管理画面でのテナント切り替え機能
2. **テナント編集CLI**: `npm run edit:tenant`
3. **テナント削除CLI**: `npm run remove:tenant`
4. **記事のマルチテナント対応**: Articlesコレクションへのテナント機能追加
5. **テナント別ダッシュボード**: 各テナントの統計情報表示
6. **テナント間データ移行**: テナント間でのデータコピー機能

## 注意事項

- テナントを削除する場合は、関連するすべてのデータも削除されます
- スーパー管理者は最低1人は必要です
- デフォルトテナントは削除しないでください